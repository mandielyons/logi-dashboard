/*jslint devel: true, bitwise: true, regexp: true, browser: true, confusion: true, unparam: true, eqeq: true, white: true, nomen: true, plusplus: true, maxerr: 50, indent: 4 */
/*globals jQuery */

/*!
 * Coverflow
 *
 * Copyright (c) 2013-2014 Martijn W. van der Lee
 * Licensed under the MIT.
 */

/* Lightweight and flexible coverflow effect using CSS3 transforms.
 * For modern browsers with some amount of graceful degradation.
 * Optional support for jQuery.interpolate() plugin.
 * Optional support for .reflect() plugins.
 *
 * Requires jQuery 1.7+ and jQueryUI 1.9+.
 * Recommended jQuery 1.8+ and jQueryUI 1.9+.
 */

!function(e,n){"use strict";var t=function(e){return 0>e?-1:1},i=function(e,n,t,i,o){return(e-n)*(o-i)/(t-n)+i};e.widget("vanderlee.coverflow",{options:{animateComplete:n,animateStep:n,density:1,duration:"normal",easing:n,index:0,innerAngle:-75,innerCss:n,innerOffset:100/3,innerScale:.75,outerAngle:-30,outerCss:n,outerScale:.25,selectedCss:n,visible:"density",width:n,change:n,confirm:n,select:n},_window_handler_resize:null,_window_handler_keydown:null,_create:function(){var n,t=this,i=t._getCovers(),o=i.filter("img").add("img",i).filter(function(){return!(this.complete||this.height>0)}),s=i.height();return t.widgetEventPrefix="vanderlee-coverflow",t.hovering=!1,t.pagesize=1,t.currentIndex=t.options.index,t.element.height(s),o.load(function(){n=t._getCovers().height(),n>s&&(s=n,t.element.height(s))}),i.hide(),t.element.on("mousedown tap","> *",function(e){var n=t._getCovers().index(this);n===t.currentIndex?t._callback("confirm",e):t._setIndex(n,!0)}),t.element.on("mousewheel",function(e,n){e.preventDefault(),t._setIndex(t.options.index-n,!0)}),e.isFunction(t.element.swipe)&&t.element.swipe({swipe:function(e,n,i){var o=Math.round(1.25*("left"===n?1:-1)*t.pagesize*i/t.element.width());t._setIndex(t.options.index+o,!0)}}),t.element.hover(function(){t.hovering=!0},function(){t.hovering=!1}),t._window_handler_resize=function(){t.refresh()},t._window_handler_keydown=function(e){if(t.hovering)switch(e.which){case 36:e.preventDefault(),t._setIndex(0,!0);break;case 35:e.preventDefault(),t._setIndex(t._getCovers().length-1,!0);break;case 38:case 37:e.preventDefault(),t._setIndex(t.options.index-1,!0);break;case 40:case 39:e.preventDefault(),t._setIndex(t.options.index+1,!0);break;case 33:e.preventDefault(),t._setIndex(t.options.index-t.pagesize,!0);break;case 34:e.preventDefault(),t._setIndex(t.options.index+t.pagesize,!0)}},e(window).on("resize",t._window_handler_resize),e(window).on("keydown",t._window_handler_keydown),t._setIndex(t.options.index,!1,!0),t},_destroy:function(){e(window).off("resize",this._window_handler_resize),e(window).off("keydown",this._window_handler_keydown),this.element.height("")},cover:function(){return e(this._getCovers()[this.options.index])},_getCovers:function(){return e("> *",this.element)},_setIndex:function(e,n,t){var i=this,o=i._getCovers();if(e=Math.max(0,Math.min(e,o.length-1)),e!==i.options.index)if(this.refresh(),n===!0||0===i.options.duration){i.options.index=Math.round(e);var s="number"==typeof i.options.duration?i.options.duration:jQuery.fx.speeds[i.options.duration]||jQuery.fx.speeds._default;this.refresh(s,i.options.index)}else i.options.index=Math.round(e),i.refresh(0);else t===!0&&(i.refresh(),i._callback("select"))},_callback:function(e,n){this._trigger(e,n,[this._getCovers().get(this.currentIndex),this.currentIndex])},index:function(e){if(e===n)return this.options.index;for(;0>e;)e+=this._getCovers().length;this._setIndex(e,!0)},_frame:function(n){n=n.toFixed(6);var o=this,s=o._getCovers(),r=s.length,a=o.element.innerWidth(),d=o.options.width||s.first().outerWidth(),l="density"===o.options.visible?Math.round(a*o.options.density/d):e.isNumeric(o.options.visible)?o.options.visible:r,h=o.element.position().left-(1-o.options.outerScale)*d*.5,c=.5*(a-o.options.outerScale*d);o.pagesize=l,s.removeClass("current").each(function(s,d){var u,p=e(d),f=s-n,_=Math.min(Math.max(-1,f/l),1),g=0==f,x=r-Math.abs(Math.round(f)),m=Math.abs(f)<=l,w=Math.sin(_*Math.PI*.5),v=Math.cos(_*Math.PI*.5),b=t(w)*i(Math.abs(w),0,1,o.options.innerOffset*o.options.density,c),M=m?i(Math.abs(v),1,0,o.options.innerScale,o.options.outerScale):0,C=t(w)*i(Math.abs(w),0,1,o.options.innerAngle,o.options.outerAngle),I=g?o.options.selectedCss||{}:e.interpolate&&o.options.outerCss&&!e.isEmptyObject(o.options.outerCss)?m?e.interpolate(o.options.innerCss||{},o.options.outerCss,Math.abs(w)):o.options.outerCss:{};Math.abs(f)<1&&(C=0-(0-C)*Math.abs(f),M=1-(1-M)*Math.abs(f),b=0-(0-b)*Math.abs(f)),u="scale("+M+","+M+") perspective("+.5*a+"px) rotateY("+C+"deg)",p[g?"addClass":"removeClass"]("current"),p[m?"show":"hide"](),p.css(e.extend(I,{left:h+c+b,"z-index":x,"-webkit-transform":u,"-ms-transform":u,transform:u})),o._trigger("animateStep",null,[d,_,m,g,w,v]),n==o.options.index&&o._trigger("animateComplete",null,[d,_,m,g,w,v])})},refresh:function(e,n){var t=this,i=null,o=t._getCovers(),s=o.length;o.css("position","absolute"),t.element.stop().animate({__coverflow_frame:n||t.options.index},{easing:t.options.easing,duration:e||0,step:function(e){t._frame(e),t.currentIndex=Math.max(0,Math.min(Math.round(e),s-1)),i!==t.currentIndex&&(i=t.currentIndex,t._callback("change"),t._callback("select"))},complete:function(){t.currentIndex=t.options.index,t._callback("change"),t._callback("select")}})}})}(jQuery);